def createVersion() {
    // result 20240131161412_22
    return new Date().format('yyyyMMddHHmmss') + "_${env.BUILD_ID}"
}
def remote = [:]
remote.name = 'mpb'
remote.host = '192.168.0.104'
remote.user = 'haorui'
remote.password = '271918141'
remote.allowAnyHosts = true
pipeline {
    agent any
    environment {
        _version = createVersion()
    }
    stages {
        stage ('Clone repository') {
            steps {
                checkout scm
            }
        }
        stage('Build docker image') { 
            steps {
                echo 'Hello Jenkins'
                sh 'docker build -t haorui215/jenkins-react:${_version} .' 
            }
        }
        stage('Push image to Hub'){
            steps{
                script{
                    withCredentials([string(credentialsId: 'dockerhub', variable: 'dockerhub')]) {
                        sh 'docker login -u haorui215 -p ${dockerhub}'
                    }
                    sh 'docker push haorui215/jenkins-react:${_version}'
                }
            }
        }
        stage('Remote SSH') {
            sshCommand remote: remote, command: "ls -lrt"
            sshCommand remote: remote, command: "docker ps"
        }
    }
}